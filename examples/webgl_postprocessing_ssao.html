<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js webgl - postprocessing - Screen Space Ambient Occlusion</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
    <style>
        body {
            background-color: #aaa;
        }
    </style>
</head>
<body>
    <div id="info">
        <a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - screen space ambient occlusion<br/>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "../build/three.module.js",
                "three/addons/": "./jsm/"
            }
        }
    </script>

    <script type="module">

        import * as THREE from 'three';
        import Stats from 'three/addons/libs/stats.module.js';
        import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';  // Import OrbitControls
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { SSAOPass } from 'three/addons/postprocessing/SSAOPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        let container, stats;
        let camera, scene, renderer, controls;
        let composer;
        let model;

        init();

        function init() {

            container = document.createElement('div');
            document.body.appendChild(container);

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setAnimationLoop(animate);
            document.body.appendChild(renderer.domElement);

            camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(250, 100, 0);  // Set initial camera position

            // Initialize OrbitControls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0, 0);  // Set the target for the camera to look at
            controls.enableDamping = true;  // Enable smooth damping (inertia)
            controls.dampingFactor = 0.05;  // Damping factor
            controls.update();

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xaaaaaa);

            scene.add(new THREE.DirectionalLight(0xffffff, 4));
            scene.add(new THREE.AmbientLight(0xffffff));

            stats = new Stats();
            container.appendChild(stats.dom);

            const width = window.innerWidth;
            const height = window.innerHeight;

            composer = new EffectComposer(renderer);

            const renderPass = new RenderPass(scene, camera);
            composer.addPass(renderPass);

            // Configure SSAO Pass
            const ssaoPass = new SSAOPass(scene, camera, width, height);
            ssaoPass.output = SSAOPass.OUTPUT.SSAO;  // Show only the SSAO effect
            composer.addPass(ssaoPass);

            const outputPass = new OutputPass();
            composer.addPass(outputPass);

            // Initialize DRACOLoader and GLTFLoader
            const dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('jsm/libs/draco/');
            dracoLoader.setDecoderConfig({ type: 'js' });

            const loader = new GLTFLoader();
            loader.setDRACOLoader(dracoLoader);

            // Load GLTF model
            loader.load('models/gltf/sponza.glb', (gltf) => {
                model = gltf.scene;
                model.position.set(0, 0, 0);
                model.scale.set(50, 50, 50);
                scene.add(model);
            }, undefined, (error) => {
                console.error('An error happened', error);
            });

            // Init GUI
            const gui = new GUI();
            gui.add(ssaoPass, 'output', {
                'Default': SSAOPass.OUTPUT.Default,
                'SSAO Only': SSAOPass.OUTPUT.SSAO,
                'SSAO Only + Blur': SSAOPass.OUTPUT.Blur,
                'Depth': SSAOPass.OUTPUT.Depth,
                'Normal': SSAOPass.OUTPUT.Normal
            }).onChange(function (value) { 
                ssaoPass.output = value;
            });
            gui.add(ssaoPass, 'kernelRadius').min(0).max(128);
            gui.add(ssaoPass, 'minDistance').min(0.001).max(50.0);
            gui.add(ssaoPass, 'maxDistance').min(0.01).max(150.0);
            gui.add(ssaoPass, 'enabled');

            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {

            const width = window.innerWidth;
            const height = window.innerHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
            composer.setSize(width, height);

        }

        function animate() {

            stats.begin();
            controls.update();  // Update controls in the animation loop
            render();
            stats.end();

        }

        function render() {

            composer.render();

        }

    </script>
</body>
</html>
